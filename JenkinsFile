pipeline {

    agent {
        node {
            label 'master'
        }
    }
    options {
        buildDiscarder logRotator( 
                    daysToKeepStr: '16', 
                    numToKeepStr: '10'
            )
    }

    stages {

        stage('Setup Environment for APICTL') {
            steps {
                sh '''#!/bin/bash
                cd /home/ec2-user/apictl
                envs=$(./apictl get envs --format "{{.Name}}")
                if [ -z "$envs" ]; 
                then 
                    echo "No environment configured. Setting dev environment.."
                    ./apictl add env dev --apim https://${APIM_HOST}:9443 
                else
                    echo "Environments :"$envs
                    if [[ $envs != *"dev"* ]]; then
                    echo "Dev environment is not configured. Setting dev environment.."
                    ./apictl add env dev --apim https://${APIM_HOST}:9443 
                    fi
                fi
                '''
            }
        }

        stage('Deploy APIs To "Dev" Environment') {
            steps {
                sh '''
                sh /home/ec2-user/apictl/apictl login dev -u admin -p admin -k
                sh /home/ec2-user/apictl/apictl vcs deploy -e dev
                '''
            }
        }

        stage('Run Tests in "Dev" Environment') {
            steps {
                sh '''#!/bin/bash
                testfiles=\$(find tests -iname "*.sh")
                for i in \$testfiles ; do bash \$i; done
                '''
            }
        }
    }
    post { 
        always { 
            sh '''
            sh /home/ec2-user/apictl/apictl logout dev
            '''
        }
    }
}
